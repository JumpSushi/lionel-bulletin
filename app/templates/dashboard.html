{% extends "base.html" %}

{% block title %}Dashboard - Student Bulletin Service{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Your Dashboard</h2>
                <div>
                    <button class="btn btn-outline-secondary" onclick="openFiltersModal()">
                        <i class="fas fa-filter"></i> Filters
                    </button>
                    <button class="btn btn-primary" onclick="fetchBulletins()">
                        <i class="fas fa-sync-alt"></i> Refresh Bulletins
                    </button>
                    <button class="btn btn-success" onclick="toggleSubscription()">
                        <i class="fas fa-envelope"></i> 
                        <span id="subscriptionText">Enable Notifications</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Subscription Status -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-info" id="subscriptionStatus" style="display:none;">
                <i class="fas fa-info-circle"></i> 
                <span id="statusMessage"></span>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-newspaper fa-2x text-muted mb-2"></i>
                    <div class="h5 mb-1" id="totalItems">0</div>
                    <div class="small text-muted">Total Items</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-star fa-2x text-muted mb-2"></i>
                    <div class="h5 mb-1" id="year9Items">0</div>
                    <div class="small text-muted">Relevant Items</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-envelope fa-2x text-muted mb-2"></i>
                    <div class="h5 mb-1" id="emailsSent">0</div>
                    <div class="small text-muted">Emails Sent</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <i class="fas fa-clock fa-2x text-muted mb-2"></i>
                    <div class="h6 mb-1" id="lastUpdate">Never</div>
                    <div class="small text-muted">Last Update</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter Controls -->
    <div class="row mb-3">
        <div class="col-md-6">
            <div class="input-group">
                <span class="input-group-text"><i class="fas fa-search"></i></span>
                <input type="text" class="form-control" id="searchInput" placeholder="Search bulletins...">
            </div>
        </div>
        <div class="col-md-3">
            <select class="form-select" id="categoryFilter">
                <option value="">All Categories</option>
                <option value="year9">Specifically Targeted</option>
                <option value="general">General</option>
                <option value="sports">Sports</option>
                <option value="academic">Academic</option>
            </select>
        </div>
        <div class="col-md-3">
            <select class="form-select" id="dateFilter">
                <option value="">All Dates</option>
                <option value="today">Today</option>
                <option value="week">This Week</option>
                <option value="month">This Month</option>
            </select>
        </div>
    </div>

    <!-- Bulletins List -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Latest Bulletins</h5>
                </div>
                <div class="card-body">
                    <div id="loadingIndicator" class="text-center py-4" style="display:none;">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading bulletins...</p>
                    </div>
                    <div id="bulletinsList">
                        <!-- Bulletins will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bulletin Detail Modal -->
<div class="modal fade" id="bulletinDetailModal" tabindex="-1" aria-labelledby="bulletinDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bulletinDetailModalLabel">Bulletin Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="bulletinDetailContent">
                <div class="text-center py-4">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading bulletin details...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-primary" id="emailDetailBtn">
                    <i class="fas fa-envelope"></i> Send Email
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Filters Modal -->
<div class="modal fade" id="filtersModal" tabindex="-1" aria-labelledby="filtersModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="filtersModalLabel">Bulletin Filters</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Filter Tabs -->
                <ul class="nav nav-tabs" id="filterTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="my-filters-tab" data-bs-toggle="tab" data-bs-target="#my-filters" type="button" role="tab">
                            My Filters
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="create-filter-tab" data-bs-toggle="tab" data-bs-target="#create-filter" type="button" role="tab">
                            Create Filter
                        </button>
                    </li>
                </ul>
                
                <div class="tab-content mt-3" id="filterTabContent">
                    <!-- My Filters Tab -->
                    <div class="tab-pane fade show active" id="my-filters" role="tabpanel">
                        <div id="userFiltersList">
                            <!-- User filters will be loaded here -->
                        </div>
                    </div>
                    
                    <!-- Create Filter Tab -->
                    <div class="tab-pane fade" id="create-filter" role="tabpanel">
                        <form id="createFilterForm">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="filterName" class="form-label">Filter Name *</label>
                                        <input type="text" class="form-control" id="filterName" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="filterDescription" class="form-label">Description</label>
                                        <input type="text" class="form-control" id="filterDescription">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="filterKeywords" class="form-label">Keywords</label>
                                        <input type="text" class="form-control" id="filterKeywords" 
                                               placeholder="Enter keywords separated by commas">
                                        <div class="form-text">Example: sports, music, drama</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="filterCategories" class="form-label">Categories</label>
                                        <select class="form-select" id="filterCategories" multiple>
                                            <!-- Options will be loaded dynamically -->
                                        </select>
                                        <div class="form-text">Hold Ctrl/Cmd to select multiple</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="filterYearGroups" class="form-label">Year Groups</label>
                                        <select class="form-select" id="filterYearGroups" multiple>
                                            <option value="7">Year 7</option>
                                            <option value="8">Year 8</option>
                                            <option value="9">Year 9</option>
                                            <option value="10">Year 10</option>
                                            <option value="11">Year 11</option>
                                            <option value="12">Year 12</option>
                                            <option value="13">Year 13</option>
                                        </select>
                                        <div class="form-text">Leave empty to use your default year group</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Exclusions</label>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="excludeFeedback" checked>
                                            <label class="form-check-label" for="excludeFeedback">
                                                Exclude Feedback Items
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="excludeDonations" checked>
                                            <label class="form-check-label" for="excludeDonations">
                                                Exclude Donation Items
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-end">
                                <button type="button" class="btn btn-secondary me-2" onclick="resetFilterForm()">Reset</button>
                                <button type="submit" class="btn btn-primary">Create Filter</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
let userSubscribed = false;
let currentBulletins = [];
let currentBulletinId = null;
let userFilters = [];

document.addEventListener('DOMContentLoaded', function() {
    console.log("Dashboard page loaded, checking authentication...");
    
    // Check authentication before loading data
    const hasAuth = requireAuth();
    
    if (!hasAuth) {
        console.log("Authentication check failed, not loading dashboard data");
        return;
    }
    
    console.log("Authentication confirmed, loading dashboard data with token:", !!localStorage.getItem('authToken'));
    loadDashboardData();
    setupEventListeners();
});

function setupEventListeners() {
    document.getElementById('searchInput').addEventListener('input', filterBulletins);
    document.getElementById('categoryFilter').addEventListener('change', filterBulletins);
    document.getElementById('dateFilter').addEventListener('change', filterBulletins);
    
    // Setup bulletin detail modal event
    document.getElementById('emailDetailBtn').addEventListener('click', function() {
        if (currentBulletinId) {
            emailBulletin(currentBulletinId);
        }
    });
}

async function loadDashboardData() {
    console.log("Starting to load dashboard data");
    
    try {
        // Check if we have a token before making API calls
        if (!localStorage.getItem('authToken')) {
            console.error("No auth token available for API calls");
            showAlert("Authentication required. Please log in again.", "danger");
            setTimeout(() => {
                window.location.href = '/login';
            }, 2000);
            return;
        }
        
        console.log("Loading dashboard data components...");
        
        try {
            await loadStats();
            console.log("Stats loaded successfully");
        } catch (error) {
            console.error("Error loading stats:", error);
        }
        
        try {
            await loadSubscriptionStatus();
            console.log("Subscription status loaded successfully");
        } catch (error) {
            console.error("Error loading subscription status:", error);
        }
        
        try {
            await fetchBulletins();
            console.log("Bulletins loaded successfully");
        } catch (error) {
            console.error("Error loading bulletins:", error);
        }
        
        console.log("Dashboard data loaded completely");
    } catch (error) {
        console.error('Error loading dashboard data:', error);
        showAlert('Error loading dashboard data: ' + (error.message || 'Unknown error'), 'danger');
        
        // Handle authentication errors more gracefully
        if (error.isAuthError || error.status === 401 || error.status === 403) {
            console.log("Authentication error while loading dashboard");
            
            // Try to refresh the token first
            try {
                const refreshed = await tryRefreshToken(true);
                if (refreshed) {
                    console.log("Token refreshed successfully, reloading data");
                    showAlert("Session refreshed. Reloading data...", "success");
                    setTimeout(() => loadDashboardData(), 1000);
                    return;
                }
            } catch (refreshError) {
                console.error("Error refreshing token:", refreshError);
            }
            
            // If refresh fails, show message and redirect
            showAlert("Your session has expired. Please log in again.", "warning");
            
            // Wait a moment before redirecting to let the user read the message
            setTimeout(() => {
                // Only redirect if we're still on the dashboard page
                if (window.location.pathname === '/dashboard') {
                    console.log("Redirecting to login page");
                    window.location.href = '/login';
                }
            }, 3000);
        }
    }
}

async function loadStats() {
    try {
        console.log("Loading dashboard stats...");
        const stats = await apiCall('/dashboard/stats');
        document.getElementById('totalItems').textContent = stats.total_bulletins || 0;
        document.getElementById('year9Items').textContent = stats.recent_bulletins || 0;
        document.getElementById('emailsSent').textContent = stats.emails_sent || 0;
        document.getElementById('lastUpdate').textContent = stats.last_update || 'Never';
    } catch (error) {
        console.error('Error loading stats:', error);
        // Don't handle auth errors here, let the parent function handle them
    }
}

async function loadSubscriptionStatus() {
    try {
        console.log("Loading subscription status...");
        const data = await apiCall('/subscription/status');
        userSubscribed = data.is_subscribed;
        updateSubscriptionUI();
    } catch (error) {
        console.error('Error loading subscription status:', error);
        // Don't handle auth errors here, let the parent function handle them
    }
}

function updateSubscriptionUI() {
    const button = document.querySelector('button[onclick="toggleSubscription()"]');
    const text = document.getElementById('subscriptionText');
    const status = document.getElementById('subscriptionStatus');
    const message = document.getElementById('statusMessage');
    
    if (userSubscribed) {
        button.className = 'btn btn-warning';
        text.textContent = 'Disable Notifications';
        message.textContent = 'You are subscribed to email notifications for relevant bulletins.';
        status.style.display = 'block';
        status.className = 'alert alert-success';
    } else {
        button.className = 'btn btn-success';
        text.textContent = 'Enable Notifications';
        message.textContent = 'Enable email notifications to receive relevant bulletins automatically.';
        status.style.display = 'block';
        status.className = 'alert alert-info';
    }
}

async function toggleSubscription() {
    try {
        console.log("Toggling subscription status...");
        const data = await apiCall('/subscription/toggle', 'POST');
        console.log("Subscription toggle response:", data);
        userSubscribed = data.is_subscribed;
        updateSubscriptionUI();
        showAlert(data.message, 'success');
    } catch (error) {
        console.error('Error toggling subscription:', error);
        
        if (error.isAuthError || error.status === 401 || error.status === 403) {
            console.log("Authentication error during subscription toggle");
            showAlert("Your session has expired. Please log in again.", "warning");
            
            // Wait a moment before redirecting
            setTimeout(() => {
                if (window.location.pathname === '/dashboard') {
                    window.location.href = '/login';
                }
            }, 3000);
        } else {
            showAlert('Error updating subscription: ' + (error.message || 'Unknown error'), 'danger');
        }
    }
}

async function fetchBulletins() {
    const loadingIndicator = document.getElementById('loadingIndicator');
    const bulletinsList = document.getElementById('bulletinsList');
    
    loadingIndicator.style.display = 'block';
    
    try {
        console.log("Fetching bulletins...");
        const data = await apiCall('/bulletins');
        currentBulletins = data.bulletins || [];
        displayBulletins(currentBulletins);
        
        // Only refresh stats if bulletins load successfully
        try {
            await loadStats();
        } catch (error) {
            console.error("Failed to refresh stats after fetching bulletins:", error);
        }
    } catch (error) {
        console.error('Error fetching bulletins:', error);
        bulletinsList.innerHTML = '<div class="alert alert-danger">Error loading bulletins. Please try again.</div>';
        // Don't handle auth errors here, let the parent function handle them
    } finally {
        loadingIndicator.style.display = 'none';
    }
}

// Helper function to filter duplicate bulletins
function filterDuplicateBulletins(bulletins) {
    const contentMap = new Map();
    return bulletins.filter(bulletin => {
        // Use the first 100 chars of content as a unique identifier
        const contentKey = bulletin.content?.substring(0, 100);
        if (!contentKey || contentMap.has(contentKey)) {
            return false;
        }
        contentMap.set(contentKey, true);
        return true;
    });
}

// Helper function to generate a title from content
function generateTitle(content) {
    if (!content) return "Untitled";
    
    // Extract first sentence (up to 60 chars)
    const firstSentence = content.split(/[.!?]/)[0].trim();
    if (firstSentence.length <= 60) {
        return firstSentence;
    }
    
    // Or first 60 characters with ellipsis
    return content.substring(0, 57) + '...';
}

// Helper function to format bulletin date
function formatBulletinDate(dateStr) {
    if (!dateStr || dateStr === 'Unknown date') {
        return 'No date specified';
    }
    
    // Try to parse the date string
    const date = new Date(dateStr);
    
    // Check if date is valid
    if (isNaN(date)) {
        // Try to extract date from string using regex
        const datePattern = /\b\d{1,2}[-/]\d{1,2}[-/]\d{2,4}\b/;
        const match = dateStr.match(datePattern);
        if (match) {
            return match[0];
        }
        return 'No date specified';
    }
    
    // Format the date
    return date.toLocaleDateString('en-GB', {
        day: 'numeric',
        month: 'short',
        year: 'numeric'
    });
}

// Helper function to truncate content
function truncateContent(content, maxLength) {
    if (!content) return '';
    
    if (content.length <= maxLength) {
        return content;
    }
    
    // Try to cut at a space to avoid cutting words
    const truncated = content.substring(0, maxLength);
    const lastSpace = truncated.lastIndexOf(' ');
    
    if (lastSpace > maxLength * 0.8) {
        return truncated.substring(0, lastSpace) + '...';
    }
    
    return truncated + '...';
}

function displayBulletins(bulletins) {
    const bulletinsList = document.getElementById('bulletinsList');
    
    if (bulletins.length === 0) {
        bulletinsList.innerHTML = '<div class="alert alert-info">No bulletins found.</div>';
        return;
    }
    
    // Filter out duplicates based on content
    const uniqueBulletins = filterDuplicateBulletins(bulletins);
    
    // Sort by date (newest first)
    uniqueBulletins.sort((a, b) => {
        // First try to parse actual date strings
        const dateA = a.date && a.date !== 'Unknown date' ? new Date(a.date) : new Date(0);
        const dateB = b.date && b.date !== 'Unknown date' ? new Date(b.date) : new Date(0);
        
        // If dates are valid, compare them
        if (!isNaN(dateA) && !isNaN(dateB)) {
            return dateB - dateA;
        }
        
        // Fallback to created_at date
        const createdA = new Date(a.created_at || 0);
        const createdB = new Date(b.created_at || 0);
        return createdB - createdA;
    });
    
    const bulletinsHTML = uniqueBulletins.map(bulletin => {
        // Generate a proper title
        const title = bulletin.ai_headline || bulletin.title || generateTitle(bulletin.content);
        
        // Format date properly
        const displayDate = formatBulletinDate(bulletin.date);
        
        // Truncate content for preview
        const previewContent = truncateContent(bulletin.content, 150);
        
        return `
        <div class="bulletin-item border-bottom py-3" data-category="${bulletin.category || 'general'}" data-date="${bulletin.date || bulletin.created_at}" data-id="${bulletin.id}">
            <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                    <h5 class="mb-1">${title}</h5>
                    <p class="mb-1 text-muted">${previewContent}</p>
                    <div class="d-flex justify-content-between align-items-center mt-2">
                        <small class="text-muted">
                            <i class="fas fa-calendar"></i> ${displayDate}
                            ${bulletin.is_year9 ? '<span class="badge bg-success ms-2">Targeted</span>' : ''}
                            ${bulletin.category ? `<span class="badge bg-secondary ms-1">${bulletin.category}</span>` : ''}
                        </small>
                        <button class="btn btn-sm btn-link" onclick="viewBulletinDetails('${bulletin.id}', '${encodeURIComponent(title)}')">
                            Read more <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
                <div class="flex-shrink-0 ms-3">
                    <button class="btn btn-sm btn-outline-primary" onclick="emailBulletin('${bulletin.id}')">
                        <i class="fas fa-envelope"></i>
                    </button>
                </div>
            </div>
        </div>
    `}).join('');
    
    bulletinsList.innerHTML = bulletinsHTML;
}

function filterBulletins() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const categoryFilter = document.getElementById('categoryFilter').value;
    const dateFilter = document.getElementById('dateFilter').value;
    
    const bulletinItems = document.querySelectorAll('.bulletin-item');
    
    bulletinItems.forEach(item => {
        const title = item.querySelector('h5').textContent.toLowerCase();
        const content = item.querySelector('p').textContent.toLowerCase();
        const category = item.getAttribute('data-category');
        const date = new Date(item.getAttribute('data-date'));
        
        let show = true;
        
        // Search filter
        if (searchTerm && !title.includes(searchTerm) && !content.includes(searchTerm)) {
            show = false;
        }
        
        // Category filter
        if (categoryFilter && category !== categoryFilter) {
            show = false;
        }
        
        // Date filter
        if (dateFilter) {
            const now = new Date();
            const daysDiff = Math.floor((now - date) / (1000 * 60 * 60 * 24));
            
            switch (dateFilter) {
                case 'today':
                    if (daysDiff !== 0) show = false;
                    break;
                case 'week':
                    if (daysDiff > 7) show = false;
                    break;
                case 'month':
                    if (daysDiff > 30) show = false;
                    break;
            }
        }
        
        item.style.display = show ? 'block' : 'none';
    });
}

async function emailBulletin(bulletinId) {
    try {
        const response = await apiCall(`/bulletins/${bulletinId}/email`, 'POST');
        showAlert('Email sent successfully!', 'success');
    } catch (error) {
        console.error('Error sending email:', error);
        showAlert('Error sending email', 'danger');
    }
}

// Function to view bulletin details
function viewBulletinDetails(bulletinId, encodedTitle) {
    const title = decodeURIComponent(encodedTitle);
    currentBulletinId = bulletinId;
    
    // Find the bulletin in our data
    const bulletin = currentBulletins.find(b => b.id == bulletinId);
    
    if (!bulletin) {
        showAlert('Error: Bulletin not found', 'danger');
        return;
    }
    
    // Set modal title
    document.getElementById('bulletinDetailModalLabel').textContent = title;
    
    // Set modal content
    const displayDate = formatBulletinDate(bulletin.date);
    
    const detailHTML = `
        <div class="bulletin-detail">
            <div class="bulletin-meta mb-3">
                <span class="badge bg-secondary me-2"><i class="fas fa-calendar"></i> ${displayDate}</span>
                ${bulletin.is_year9 ? '<span class="badge bg-success me-2">Targeted</span>' : ''}
                ${bulletin.category ? `<span class="badge bg-info me-2">${bulletin.category}</span>` : ''}
            </div>
            
            <div class="bulletin-content mb-4">
                ${bulletin.content.replace(/\n/g, '<br>')}
            </div>
            
            ${bulletin.attachments && bulletin.attachments.length > 0 ? `
                <div class="bulletin-attachments mt-3">
                    <h6><i class="fas fa-paperclip"></i> Attachments</h6>
                    <ul class="list-group">
                        ${bulletin.attachments.map(att => `
                            <li class="list-group-item">
                                <a href="${att.url}" target="_blank">
                                    <i class="fas fa-file"></i> ${att.name || 'Attachment'}
                                </a>
                            </li>
                        `).join('')}
                    </ul>
                </div>
            ` : ''}
            
            <div class="bulletin-metadata mt-4 pt-3 border-top small text-muted">
                <div><strong>Added:</strong> ${new Date(bulletin.created_at).toLocaleString()}</div>
                ${bulletin.metadata ? Object.entries(bulletin.metadata).map(([key, value]) => 
                    `<div><strong>${key}:</strong> ${value}</div>`
                ).join('') : ''}
            </div>
        </div>
    `;
    
    document.getElementById('bulletinDetailContent').innerHTML = detailHTML;
    
    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('bulletinDetailModal'));
    modal.show();
}

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 end-0 m-3`;
    alertDiv.style.zIndex = '9999';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}

// Filter Management Functions
async function openFiltersModal() {
    await loadUserFilters();
    await loadFilterOptions();
    const modal = new bootstrap.Modal(document.getElementById('filtersModal'));
    modal.show();
}

async function loadUserFilters() {
    try {
        const response = await fetch('/api/filters', {
            headers: {
                'Authorization': `Bearer ${authToken}`
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            userFilters = data.filters || [];
            displayUserFilters();
        }
    } catch (error) {
        console.error('Error loading user filters:', error);
    }
}

function displayUserFilters() {
    const container = document.getElementById('userFiltersList');
    
    if (userFilters.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-filter fa-3x mb-3"></i>
                <p>You haven't created any filters yet.</p>
                <p>Use the "Create Filter" tab to get started!</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = userFilters.map(filter => `
        <div class="card mb-3">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6 class="card-title mb-1">${filter.name}</h6>
                        <p class="card-text text-muted small mb-2">${filter.description || 'No description'}</p>
                        <div class="filter-details">
                            ${filter.keywords.length > 0 ? 
                                `<span class="badge bg-info me-1">Keywords: ${filter.keywords.join(', ')}</span>` : ''
                            }
                            ${filter.categories.length > 0 ? 
                                `<span class="badge bg-secondary me-1">Categories: ${filter.categories.join(', ')}</span>` : ''
                            }
                            ${filter.year_groups.length > 0 ? 
                                `<span class="badge bg-success me-1">Years: ${filter.year_groups.join(', ')}</span>` : ''
                            }
                        </div>
                    </div>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary" onclick="applyFilter(${filter.id})" title="Apply Filter">
                            <i class="fas fa-play"></i>
                        </button>
                        <button class="btn btn-outline-secondary" onclick="editFilter(${filter.id})" title="Edit Filter">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-outline-danger" onclick="deleteFilter(${filter.id})" title="Delete Filter">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                <div class="mt-2">
                    <small class="text-muted">
                        Created: ${new Date(filter.created_at).toLocaleDateString()}
                        ${filter.updated_at !== filter.created_at ? 
                            `• Updated: ${new Date(filter.updated_at).toLocaleDateString()}` : ''
                        }
                    </small>
                </div>
            </div>
        </div>
    `).join('');
}

async function loadFilterOptions() {
    try {
        const response = await fetch('/api/filter-options', {
            headers: {
                'Authorization': `Bearer ${authToken}`
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            
            // Populate categories dropdown
            const categoriesSelect = document.getElementById('filterCategories');
            categoriesSelect.innerHTML = data.categories.map(cat => 
                `<option value="${cat}">${cat}</option>`
            ).join('');
        }
    } catch (error) {
        console.error('Error loading filter options:', error);
    }
}

async function applyFilter(filterId) {
    try {
        // Close the filters modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('filtersModal'));
        modal.hide();
        
        // Show loading state
        document.getElementById('bulletinsList').innerHTML = `
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Applying filter...</p>
            </div>
        `;
        
        const response = await fetch(`/api/filters/${filterId}/apply`, {
            headers: {
                'Authorization': `Bearer ${authToken}`
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            currentBulletins = data.bulletins || [];
            
            // Update the page title to show filter is active
            const filterName = userFilters.find(f => f.id === filterId)?.name || 'Filter';
            document.querySelector('h2').innerHTML = `
                Your Dashboard 
                <span class="badge bg-primary ms-2">Filter: ${filterName}</span>
                <button class="btn btn-sm btn-outline-secondary ms-2" onclick="clearFilter()">
                    <i class="fas fa-times"></i> Clear
                </button>
            `;
            
            displayBulletins(currentBulletins);
            showAlert(`Filter "${filterName}" applied successfully! Showing ${currentBulletins.length} items.`, 'success');
        } else {
            const error = await response.json();
            showAlert(error.error || 'Failed to apply filter', 'danger');
            fetchBulletins(); // Fallback to regular bulletins
        }
    } catch (error) {
        console.error('Error applying filter:', error);
        showAlert('Error applying filter', 'danger');
        fetchBulletins(); // Fallback to regular bulletins
    }
}

function clearFilter() {
    // Reset the page title
    document.querySelector('h2').textContent = 'Your Dashboard';
    
    // Reload regular bulletins
    fetchBulletins();
    showAlert('Filter cleared', 'info');
}

async function deleteFilter(filterId) {
    if (!confirm('Are you sure you want to delete this filter?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/filters/${filterId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${authToken}`
            }
        });
        
        if (response.ok) {
            await loadUserFilters();
            showAlert('Filter deleted successfully', 'success');
        } else {
            const error = await response.json();
            showAlert(error.error || 'Failed to delete filter', 'danger');
        }
    } catch (error) {
        console.error('Error deleting filter:', error);
        showAlert('Error deleting filter', 'danger');
    }
}

function editFilter(filterId) {
    const filter = userFilters.find(f => f.id === filterId);
    if (!filter) return;
    
    // Switch to create filter tab and populate form
    document.getElementById('create-filter-tab').click();
    
    // Populate form fields
    document.getElementById('filterName').value = filter.name;
    document.getElementById('filterDescription').value = filter.description || '';
    document.getElementById('filterKeywords').value = filter.keywords.join(', ');
    document.getElementById('excludeFeedback').checked = filter.exclude_feedback;
    document.getElementById('excludeDonations').checked = filter.exclude_donations;
    
    // Set selected categories
    const categoriesSelect = document.getElementById('filterCategories');
    Array.from(categoriesSelect.options).forEach(option => {
        option.selected = filter.categories.includes(option.value);
    });
    
    // Set selected year groups
    const yearGroupsSelect = document.getElementById('filterYearGroups');
    Array.from(yearGroupsSelect.options).forEach(option => {
        option.selected = filter.year_groups.includes(option.value);
    });
    
    // Store the filter ID for updating
    document.getElementById('createFilterForm').dataset.editingId = filterId;
    
    // Change button text
    const submitBtn = document.querySelector('#createFilterForm button[type="submit"]');
    submitBtn.textContent = 'Update Filter';
    submitBtn.className = 'btn btn-warning';
}

function resetFilterForm() {
    document.getElementById('createFilterForm').reset();
    delete document.getElementById('createFilterForm').dataset.editingId;
    
    // Reset button
    const submitBtn = document.querySelector('#createFilterForm button[type="submit"]');
    submitBtn.textContent = 'Create Filter';
    submitBtn.className = 'btn btn-primary';
}

// Handle filter form submission
document.addEventListener('DOMContentLoaded', function() {
    // ...existing code...
    
    // Setup filter form submission
    const createFilterForm = document.getElementById('createFilterForm');
    if (createFilterForm) {
        createFilterForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const editingId = this.dataset.editingId;
            
            // Collect form data
            const filterData = {
                name: document.getElementById('filterName').value.trim(),
                description: document.getElementById('filterDescription').value.trim(),
                keywords: document.getElementById('filterKeywords').value
                    .split(',')
                    .map(k => k.trim())
                    .filter(k => k.length > 0),
                categories: Array.from(document.getElementById('filterCategories').selectedOptions)
                    .map(option => option.value),
                year_groups: Array.from(document.getElementById('filterYearGroups').selectedOptions)
                    .map(option => option.value),
                exclude_feedback: document.getElementById('excludeFeedback').checked,
                exclude_donations: document.getElementById('excludeDonations').checked
            };
            
            try {
                const url = editingId ? `/api/filters/${editingId}` : '/api/filters';
                const method = editingId ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(filterData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    resetFilterForm();
                    await loadUserFilters();
                    
                    // Switch back to My Filters tab
                    document.getElementById('my-filters-tab').click();
                    
                    const action = editingId ? 'updated' : 'created';
                    showAlert(`Filter "${filterData.name}" ${action} successfully`, 'success');
                } else {
                    const error = await response.json();
                    showAlert(error.error || `Failed to ${editingId ? 'update' : 'create'} filter`, 'danger');
                }
            } catch (error) {
                console.error('Error saving filter:', error);
                showAlert(`Error ${editingId ? 'updating' : 'creating'} filter`, 'danger');
            }
        });
    }
});
</script>
{% endblock %}
